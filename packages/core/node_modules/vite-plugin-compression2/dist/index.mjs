var at=Object.create;var I=Object.defineProperty;var ut=Object.getOwnPropertyDescriptor;var lt=Object.getOwnPropertyNames;var pt=Object.getPrototypeOf,ct=Object.prototype.hasOwnProperty;var mt=(t,e)=>()=>(t&&(e=t(t=0)),e);var V=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),ft=(t,e)=>{for(var n in e)I(t,n,{get:e[n],enumerable:!0})},q=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of lt(e))!ct.call(t,i)&&i!==n&&I(t,i,{get:()=>e[i],enumerable:!(r=ut(e,i))||r.enumerable});return t};var gt=(t,e,n)=>(n=t!=null?at(pt(t)):{},q(e||!t||!t.__esModule?I(n,"default",{value:t,enumerable:!0}):n,t)),dt=t=>q(I({},"__esModule",{value:!0}),t);var W={};ft(W,{TypedArrayPrototype:()=>wt,defineEsShim:()=>Ct,defineProperties:()=>Y,makeEsShim:()=>Q,uncurryThis:()=>Z});function Q(t,e){Y(t,{implementation:e,getPolyfill:()=>e,shim:()=>e})}function Ct(t,e=!1,n=null){return{implementation:t,polyfill:()=>t,shim:()=>t,auto(){},index(){let r=n||(e?t:Z(t));return Q(r,t),r}}}var Z,wt,At,Y,X=mt(()=>{Z=t=>(e,...n)=>t.call(e,...n),wt=Object.getPrototypeOf(Uint8Array.prototype),At=(t,e,n,r)=>{if(e in t){if(r===!0){if(t[e]===n)return}else if(typeof r!="function"||!r())return}Object.defineProperty(t,e,{configurable:!0,enumerable:!1,value:n,writable:!0})},Y=(t,e,n)=>{let r=Array.prototype.concat.call(Object.keys(e),Object.getOwnPropertySymbols(e));for(let i=0,o=r.length;i<o;i++){let s=r[i];At(t,s,e[s],n==null?void 0:n[s])}}});var J=V((A,$)=>{"use strict";Object.defineProperty(A,"__esModule",{value:!0}),Object.defineProperty(A,"default",{enumerable:!0,get:function(){return vt}});var xt=(X(),dt(W)),Tt=typeof AggregateError=="function"?AggregateError:(()=>{function t(e,n){let r=Error(n);return Object.setPrototypeOf(r,t.prototype),delete r.constructor,Object.defineProperty(r,"errors",{value:Array.from(e)}),r}return Object.defineProperty(t,"prototype",{writable:!1}),Object.defineProperties(t.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:t},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(t.prototype,Error.prototype),t})(),vt=(0,xt.defineEsShim)(Tt,!0);Object.assign(A.default,A);$.exports=A.default});var H=V((Zt,K)=>{"use strict";K.exports=J().index()});import j from"fs/promises";import jt from"fs";import Et from"os";import O from"path";import{createFilter as It}from"@rollup/pluginutils";import S from"fs/promises";import _ from"path";function h(t){return t.length}function N(t,e){let n=typeof e=="function"?e(t):e,{dir:r,base:i}=_.parse(t),o=r?r+"/":"";return n.replace(/\[path\]/,o).replace(/\[base\]/,i)}function w(t){return/^\\\\\?\\/.test(t)?t:t.replace(/\\/g,"/")}async function L(t){let e=await Promise.all((await S.readdir(t)).map(i=>_.join(t,i))),n=0,r=[];for(;n!==h(e);){let i=e[n],o=await S.stat(i);if(o.isDirectory()){let s=await S.readdir(i);e.push(...s.map(c=>_.join(i,c)))}o.isFile()&&r.push(i),n++}return r}function B(t){return typeof t=="string"?new TextEncoder().encode(t):t}import b from"zlib";import ht from"util";import yt from"fs";import bt from"fs/promises";import z from"path";import Ot from"tar-stream";import Pt from"gunzip-maybe";function D(t){let e=t in b?t:"gzip";return{algorithm:ht.promisify(b[e])}}async function R(t,e,n){try{return await e(t,n)}catch(r){return Promise.reject(r)}}var M={gzip:{level:b.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[b.constants.BROTLI_PARAM_QUALITY]:b.constants.BROTLI_MAX_QUALITY}},deflate:{level:b.constants.Z_BEST_COMPRESSION},deflateRaw:{level:b.constants.Z_BEST_COMPRESSION}};function G(){let t=Ot.pack(),e={dests:[],root:""};return{add:(s,c)=>{t.entry({name:s},Buffer.from(B(c)))},write:async()=>{t.finalize(),await Promise.all(e.dests.map(async s=>{let c=w(z.resolve(e.root,s+".tar.gz")),m=w(z.dirname(c));e.root!==m&&await bt.mkdir(m,{recursive:!0});let l=yt.createWriteStream(c);t.pipe(Pt()).pipe(l)}))},setOptions:s=>Object.assign(e,s)}}var tt=gt(H());var F=class{constructor(e){this.maxConcurrent=e,this.queue=[],this.errors=[],this.running=0}enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e()}catch(n){this.errors.push(n)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(h(this.errors))throw new tt.default(this.errors,"task failed")}};function k(t){return new F(t)}var et="vite:build-import-analysis",nt="vite-plugin-compression",Bt="copyPublicDir",rt=(()=>{let t=Et.cpus()||{length:1};return t.length===1?10:Math.max(1,t.length-1)})();function it(t){var r;let e=new Set,n=(i,o)=>w(O.resolve(i,o));return(r=t.build.rollupOptions)!=null&&r.output?(Array.isArray(t.build.rollupOptions.output)?t.build.rollupOptions.output:[t.build.rollupOptions.output]).forEach(o=>{typeof o=="object"&&!h(Object.keys(o))||e.add(n(t.root,o.dir||t.build.outDir))}):e.add(n(t.root,t.build.outDir)),e}async function St(t,e){let n=t.generateBundle;if(typeof n=="object"&&n.handler){let r=n.handler;n.handler=async function(...i){await r.apply(this,i),await e.apply(this,i)}}typeof n=="function"&&(t.generateBundle=async function(...r){await n.apply(this,r),await e.apply(this,r)})}async function ot(t,e){let n=Bt in t.build?t.build.copyPublicDir:!0;if(t.publicDir&&n&&jt.existsSync(t.publicDir)){let r=await L(t.publicDir),i=O.join(t.root,O.relative(t.root,t.publicDir));await Promise.all(r.map(async o=>{let s=w(O.relative(i,o));await e(s,o)}))}}function ne(t={}){let{dest:e}=t,n=[],r=[],i=[],o=process.cwd(),s=G(),c=k(rt),m;return{name:"vite-plugin-tarball",enforce:"post",async configResolved(l){if(r.push(...it(l)),o=l.root,i=e?[e]:r,s.setOptions({dests:i,root:o}),m=U.getPluginAPI(l.plugins),m||await ot(l,async f=>{n.push(f)}),!l.plugins.find(f=>f.name===et))throw new Error("vite-plugin-cp can't be work in versions lower than vite2.0.0")},async writeBundle(l,g){for(let f in g){let a=g[f];s.add(f,a.type==="asset"?a.source:a.code)}},async closeBundle(){!n.length&&m&&m.staticOutputs&&n.push(...m.staticOutputs);for(let l of r)for(let g of n)c.enqueue(async()=>{let f=O.join(l,g),a=await j.readFile(f);s.add(g,a)});await c.wait(),await s.write()}}}function U(t={}){let{include:e=/\.(html|xml|css|json|js|mjs|svg)$/,exclude:n,threshold:r=0,algorithm:i="gzip",filename:o,compressionOptions:s,deleteOriginalAssets:c=!1,skipIfLargerOrEqual:m=!0}=t,l=It(e,n),g=[],f=[],a=Object.create(null);a.algorithm=typeof i=="string"?D(i).algorithm:i,a.options=typeof i=="function"?s:Object.assign(M[i],s),a.filename=o!=null?o:i==="brotliCompress"?"[path][base].br":"[path][base].gz";let E=k(rt),st=async function(d,p){for(let u in p){if(!l(u))continue;let C=p[u],x=B(C.type==="asset"?C.source:C.code),T=h(x);T<r||E.enqueue(async()=>{let P=N(u,a.filename),v=await R(x,a.algorithm,a.options);m&&h(v)>=T||((c||u===P)&&Reflect.deleteProperty(p,u),this.emitFile({type:"asset",fileName:P,source:v}))})}await E.wait().catch(this.error)},y={staticOutputs:new Set};return{name:nt,apply:"build",enforce:"post",api:y,async configResolved(d){f.push(...it(d)),await ot(d,async u=>{g.push(u)});let p=d.plugins.find(u=>u.name===et);if(!p)throw new Error("vite-plugin-compression can't be work in versions lower than vite2.0.0");St(p,st)},async closeBundle(){for(let d of f)for(let p of g)E.enqueue(async()=>{let u=O.join(d,p);if(!l(u)&&!y.staticOutputs.has(p))y.staticOutputs.add(p);else{let{size:C}=await j.stat(u);if(C<r)y.staticOutputs.has(p)||y.staticOutputs.add(p);else{let x=await j.readFile(u),T=await R(x,a.algorithm,a.options);if(m&&h(T)>=h(x))return;let P=N(p,a.filename);y.staticOutputs.has(P)||y.staticOutputs.add(P);let v=O.join(d,P);c&&v!==u&&await j.rm(u,{recursive:!0,force:!0}),await j.writeFile(v,T)}}});await E.wait().catch(d=>d)}}}U.getPluginAPI=t=>{var e;return(e=t.find(n=>n.name===nt))==null?void 0:e.api};var re=U;export{U as compression,re as default,ne as tarball};
